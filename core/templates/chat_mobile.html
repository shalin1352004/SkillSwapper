{% load static %}
{% if request.user == request_obj.sender %}
  {% with other_user=request_obj.receiver %}
    <div class="wa-mobile-root dark">
      <div class="wa-main-header">
        <button class="wa-back-btn" onclick="window.history.back()" aria-label="Back">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:28px;height:28px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <a href="{% url 'user_profile' other_user.id %}" class="wa-main-avatar">
          {{ other_user.username|slice:":1"|upper }}
        </a>
        <div class="wa-main-name">{{ other_user.username }}</div>
      </div>
      <div class="wa-messages" id="wa-messages">
        {% regroup messages by timestamp.date as day_groups %}
        {% for day in day_groups %}
          <div class="wa-date-separator">{{ day.grouper|date:"l, F j, Y" }}</div>
          {% for msg in day.list %}
            <div class="wa-message {% if msg.sender == user %}own{% else %}other{% endif %}">
              <div class="wa-bubble">
                <div>{{ msg.message }}</div>
                <span class="wa-message-time">{{ msg.timestamp|date:"g:i A" }}</span>
                {% if msg.sender == user %}
                  {% if msg.read %}
                    <span style="color:#34b7f1;font-size:13px;vertical-align:middle;letter-spacing:-2px;">&#10003;&#10003;</span>
                  {% else %}
                    <span style="color:#888;font-size:13px;vertical-align:middle;letter-spacing:-2px;">&#10003;&#10003;</span>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% endfor %}
      </div>
      <form method="post" class="wa-input-container">
        {% csrf_token %}
        <input type="text" name="message" class="wa-input" placeholder="Type a message..." required autocomplete="off">
        <button type="submit" class="wa-send-button" aria-label="Send">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </form>
    </div>
  {% endwith %}
{% else %}
  {% with other_user=request_obj.sender %}
    <div class="wa-mobile-root dark">
      <div class="wa-main-header">
        <button class="wa-back-btn" onclick="window.history.back()" aria-label="Back">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:28px;height:28px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <a href="{% url 'user_profile' other_user.id %}" class="wa-main-avatar">
          {{ other_user.username|slice:":1"|upper }}
        </a>
        <div class="wa-main-name">{{ other_user.username }}</div>
      </div>
      <div class="wa-messages" id="wa-messages">
        {% regroup messages by timestamp.date as day_groups %}
        {% for day in day_groups %}
          <div class="wa-date-separator">{{ day.grouper|date:"l, F j, Y" }}</div>
          {% for msg in day.list %}
            <div class="wa-message {% if msg.sender == user %}own{% else %}other{% endif %}">
              <div class="wa-bubble">
                <div>{{ msg.message }}</div>
                <span class="wa-message-time">{{ msg.timestamp|date:"g:i A" }}</span>
                {% if msg.sender == user %}
                  {% if msg.read %}
                    <span style="color:#34b7f1;font-size:13px;vertical-align:middle;letter-spacing:-2px;">&#10003;&#10003;</span>
                  {% else %}
                    <span style="color:#888;font-size:13px;vertical-align:middle;letter-spacing:-2px;">&#10003;&#10003;</span>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% endfor %}
      </div>
      <form method="post" class="wa-input-container">
        {% csrf_token %}
        <input type="text" name="message" class="wa-input" placeholder="Type a message..." required autocomplete="off">
        <button type="submit" class="wa-send-button" aria-label="Send">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </form>
    </div>
  {% endwith %}
{% endif %}
<style>
.wa-mobile-root.dark { width: 100vw; height: 100vh; background: #111b21; display: flex; flex-direction: column; }
.wa-main-header { background: #202c33; border-bottom: 1px solid #222d34; width: 100vw; display: flex; align-items: center; padding: 10px 8px; min-height: 56px; }
.wa-back-btn { background: none; border: none; color: #d1f2eb; margin-right: 8px; display: flex; align-items: center; }
.wa-main-avatar { width: 38px; height: 38px; border-radius: 50%; background: #25d366; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 1em; margin-right: 10px; }
.wa-main-name { font-weight: 600; font-size: 1.1em; color: #f7faff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.wa-messages { flex: 1; padding: 18px 0 0 0; margin: 0; overflow-y: auto; background: #111b21; display: flex; flex-direction: column; min-height: 0; box-sizing: border-box; width: 100vw; }
.wa-date-separator { text-align: center; margin: 14px 0 8px 0; color: #8696a0; font-size: 13px; font-weight: 500; letter-spacing: 0.5px; }
.wa-date-separator:before, .wa-date-separator:after { content: ''; display: inline-block; width: 24px; height: 1px; background: #222d34; vertical-align: middle; margin: 0 6px; }
.wa-message { margin-bottom: 2px; display: flex; align-items: flex-end; width: 100%; }
.wa-message.own { justify-content: flex-end; }
.wa-message.other { justify-content: flex-start; }
.wa-bubble { max-width: 90vw; min-width: 0; margin: 2px 2vw; box-sizing: border-box; border-radius: 7.5px; background: #202c33; color: #e9edef; font-size: 1.05em; box-shadow: 0 1px 1.5px rgba(0,0,0,0.04); padding: 10px 14px 8px 14px; word-break: break-word; position: relative; }
.wa-message.own .wa-bubble { background: #005c4b; color: #e9edef; border-bottom-right-radius: 0; }
.wa-message.other .wa-bubble { background: #202c33; color: #e9edef; border-bottom-left-radius: 0; align-items: flex-start; }
.wa-bubble:hover { background: #2a3942; }
.wa-message-time { font-size: 11px; color: #8696a0; margin-top: 4px; text-align: right; display: block; }
.wa-input-container { background: #202c33; padding: 8px 0; display: flex; align-items: center; justify-content: center; gap: 6px; border-top: 1px solid #222d34; width: 100vw; box-shadow: none; flex-shrink: 0; margin: 0; }
.wa-input { flex: 1 1 auto; max-width: 90vw; min-width: 60px; width: 100%; background: #2a3942; border: none; border-radius: 20px; padding: 12px 12px; font-size: 1.1em; color: #e9edef; margin: 0 4vw; box-sizing: border-box; outline: none; }
.wa-send-button { background: #25d366; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; min-width: 40px; min-height: 40px; font-size: 1em; }
.wa-send-button:hover { background: #128c7e; }
@media (max-width: 600px) {
  .wa-main-header, .wa-input-container, .wa-messages, .wa-mobile-root.dark { width: 100vw !important; }
  .wa-main-avatar { width: 34px !important; height: 34px !important; }
  .wa-input { font-size: 1em !important; padding: 10px 10px !important; }
  .wa-bubble { font-size: 1em !important; padding: 8px 10px 6px 10px !important; }
}
</style>
<script>
const waMessages = document.getElementById('wa-messages');
if (waMessages) { waMessages.scrollTop = waMessages.scrollHeight; }
</script> 